---
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase";

export const prerender = false;

const { url, redirect } = Astro;

// Get the token_hash and type from URL parameters
const token_hash = url.searchParams.get("token_hash");
const type = url.searchParams.get("type");

let error = null;

if (token_hash && type) {
  const { error: verificationError } = await supabase.auth.verifyOtp({
    token_hash,
    type: "email",
  });

  if (!verificationError) {
    return redirect("/login?success=true");
  }

  error = verificationError.message;
}
---

<Layout title="Confirm Email">
  <div class="flex flex-col items-center justify-center flex-1">
    {
      error ? (
        <div class="text-red-500 mb-4">
          <p>Error: {error}</p>
          <p class="mt-4">
            <a href="/login" class="text-blue-500 hover:underline">
              Return to log in
            </a>
          </p>
        </div>
      ) : (
        <div class="text-center">
          <h1 class="text-2xl font-bold mb-4">Verifying your email...</h1>
          <p>Please wait while we confirm your email address.</p>
        </div>
      )
    }
  </div>
</Layout>
