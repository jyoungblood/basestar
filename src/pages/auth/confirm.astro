---
import Layout from "../../layouts/Layout.astro";
import { createClient } from "../../lib/supabase";

export const prerender = false;

const supabase = createClient.server(Astro.cookies);

const { url, redirect } = Astro;

// Get the token_hash and type from URL parameters
const token_hash = url.searchParams.get("token_hash");
const type = url.searchParams.get("type");

let error = null;

if (token_hash && type) {
  const { data, error: verificationError } = await supabase.auth.verifyOtp({
    token_hash,
    type: "signup",
  });

  if (!verificationError) {
    return redirect(`/login?success=${encodeURIComponent("Email verified successfully")}`);
  }

  error = verificationError.message;
}
---

<Layout title="Confirm Email">
  <div class="flex flex-col items-center justify-center flex-1">
    {
      error ? (
        <div class="border border-gray-200 p-8 rounded-md">
          <h1 class="text-xl font-bold mb-2">Error</h1>
          <p class="text-sm">{error}</p>
        </div>
      ) : (
        <div class="border border-gray-200 p-8 rounded-md">
          <h1 class="text-xl font-bold mb-2">Verifying your email...</h1>
          <p class="text-sm">
            Please wait while we confirm your email address.
          </p>
        </div>
      )
    }
  </div>
</Layout>
